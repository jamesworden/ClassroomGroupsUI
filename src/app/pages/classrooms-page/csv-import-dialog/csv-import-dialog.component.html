<div class="w-full h-full">
  <!-- Header with progress indicator -->
  <div class="pb-4 shadow-md dark:shadow-zinc-800">
    <h2 mat-dialog-title class="mb-4 font-medium dark:text-white">
      Import Students from CSV
    </h2>
    <div class="-mb-6">
      <mat-horizontal-stepper
        [linear]="true"
        [selectedIndex]="currentStep() - 1"
        #stepper
        (selectionChange)="
          $event.previouslySelectedIndex !== $event.selectedIndex &&
            selectStep($event.selectedIndex + 1)
        "
      >
        @for (step of [1, 2]; track step) {
          <mat-step
            [completed]="currentStep() > step"
            [editable]="currentStep() >= step"
          >
            <ng-template matStepLabel>{{ getStepLabel(step) }}</ng-template>
          </mat-step>
        }
      </mat-horizontal-stepper>
    </div>
  </div>

  <mat-dialog-content>
    <!-- Loading indicator -->
    @if (isLoading()) {
      <mat-progress-bar mode="indeterminate" class="mb-6"></mat-progress-bar>
    }

    <!-- Step 1: CSV Preview -->
    @if (currentStep() === 1) {
      <div class="py-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="m-0 font-medium dark:text-white">Preview your CSV file</h3>
          <div class="flex items-center text-zinc-600 dark:text-zinc-300">
            <mat-icon class="mr-2 text-md">description</mat-icon>
            <span>{{ data.fileName }}</span>
          </div>
        </div>

        <div class="mb-8">
          <div class="border border-zinc-500 dark:border-zinc-600 rounded">
            <table mat-table [dataSource]="previewData()">
              @for (column of csvHeaders(); track column; let i = $index) {
                <ng-container [matColumnDef]="column">
                  <th mat-header-cell *matHeaderCellDef>{{ column }}</th>
                  <td mat-cell *matCellDef="let row">{{ row[column] }}</td>
                </ng-container>
              }

              <tr
                mat-header-row
                *matHeaderRowDef="displayedPreviewColumns()"
              ></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: displayedPreviewColumns()"
              ></tr>
            </table>
          </div>

          @if (previewData().length > 0) {
            <div
              class="flex items-center mt-2 text-zinc-600 dark:text-zinc-300 text-sm"
            >
              <mat-icon class="mr-1 text-md">info</mat-icon>
              <span>Showing {{ previewData().length }} of many rows</span>
            </div>
          }
        </div>

        <div class="mb-6">
          <h4 class="mt-0 mb-4 font-medium dark:text-white">Detected Fields</h4>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
            @for (field of detectedFields(); track field) {
              <div
                class="bg-zinc-100 dark:bg-zinc-800 rounded p-3 border border-transparent dark:border-zinc-700"
              >
                <div class="flex justify-between items-center mb-2">
                  <span class="font-medium dark:text-white">{{
                    field.csvHeader
                  }}</span>
                  @switch (field.fieldType) {
                    @case (FieldType.TEXT) {
                      <span
                        class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-900 dark:bg-blue-900 dark:text-blue-100 uppercase border border-blue-300 dark:border-blue-700 ml-2"
                        >text</span
                      >
                    }
                    @case (FieldType.NUMBER) {
                      <span
                        class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-900 dark:bg-green-900 dark:text-green-100 uppercase border border-green-300 dark:border-green-700 ml-2"
                        >grade</span
                      >
                    }
                    @case (FieldType.EMAIL) {
                      <span
                        class="text-xs px-2 py-1 rounded-full bg-orange-100 text-orange-900 dark:bg-orange-900 dark:text-orange-100 uppercase border border-orange-300 dark:border-orange-700 ml-2"
                        >email</span
                      >
                    }
                    @case (FieldType.DATE) {
                      <span
                        class="text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-900 dark:bg-purple-900 dark:text-purple-100 uppercase border border-purple-300 dark:border-purple-700 ml-2"
                        >date</span
                      >
                    }
                  }
                </div>
                <div
                  class="text-sm text-zinc-600 dark:text-zinc-300 flex gap-2"
                >
                  <span class="font-medium">Sample:</span>
                  <span class="truncate">{{ field.sampleData }}</span>
                </div>
              </div>
            }
          </div>
        </div>

        @if (importSummary().warnings.length > 0) {
          <div
            class="bg-amber-50 dark:bg-amber-900/30 rounded p-4 mb-6 border border-amber-200 dark:border-amber-800"
          >
            <h4
              class="mt-0 mb-2 font-medium text-amber-800 dark:text-amber-200"
            >
              Validation Issues
            </h4>
            <ul class="list-none p-0 m-0">
              @for (warning of importSummary().warnings; track warning) {
                <li class="flex items-start mb-1">
                  <mat-icon
                    class="mr-2 text-amber-600 dark:text-amber-400 text-lg h-[18px] w-[18px]"
                    >warning</mat-icon
                  >
                  <span class="dark:text-amber-100">{{ warning }}</span>
                </li>
              }
            </ul>
          </div>
        }

        <div class="flex gap-6 mt-6">
          <div
            class="bg-zinc-100 dark:bg-zinc-800 rounded p-4 flex-1 text-center border border-transparent dark:border-zinc-700"
          >
            <div class="text-sm text-zinc-600 dark:text-zinc-300 mb-2">
              Total Rows
            </div>
            <div class="text-xl font-medium dark:text-white">
              {{ importSummary().totalRows }}
            </div>
          </div>
          <div
            class="bg-zinc-100 dark:bg-zinc-800 rounded p-4 flex-1 text-center border border-transparent dark:border-zinc-700"
          >
            <div class="text-sm text-zinc-600 dark:text-zinc-300 mb-2">
              Valid Rows
            </div>
            <div class="text-xl font-medium dark:text-white">
              {{ importSummary().validRows }}
            </div>
          </div>
          @if (importSummary().errorRows > 0) {
            <div
              class="bg-zinc-100 dark:bg-zinc-800 rounded p-4 flex-1 text-center border border-transparent dark:border-zinc-700"
            >
              <div class="text-sm text-zinc-600 dark:text-zinc-300 mb-2">
                Rows with Issues
              </div>
              <div class="text-xl font-medium text-red-500 dark:text-red-400">
                {{ importSummary().errorRows }}
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- Step 2: Class Selection -->
    @if (currentStep() === 2) {
      <div class="pb-6">
        <div class="mb-6" [formGroup]="classNameForm">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Class Name</mat-label>
            <input
              matInput
              formControlName="className"
              placeholder="e.g. Math 101 - Spring 2025"
              #classNameInput
              autocomplete="off"
              [maxLength]="MAX_CLASSROOM_NAME_LENGTH"
            />
            <mat-hint align="end">
              {{ classNameForm.get('className')?.value?.length || 0 }}/{{
                MAX_CLASSROOM_NAME_LENGTH
              }}
            </mat-hint>
            <mat-error
              *ngIf="classNameForm.get('className')?.hasError('required')"
            >
              Class name is required
            </mat-error>
            <mat-error
              *ngIf="classNameForm.get('className')?.hasError('maxlength')"
            >
              Class name cannot exceed
              {{ MAX_CLASSROOM_NAME_LENGTH }} characters
            </mat-error>
          </mat-form-field>
        </div>

        <div
          class="bg-zinc-100 dark:bg-zinc-800 rounded p-4 mb-4 border border-transparent dark:border-zinc-700"
        >
          <h4 class="mt-0 mb-2 font-medium dark:text-white">Import Summary</h4>
          <p class="mb-4 dark:text-zinc-200">
            You are about to import
            <strong class="dark:text-white">{{
              importSummary().validRows
            }}</strong>
            students to the class.
          </p>

          <div>
            <h5 class="mb-2 font-medium dark:text-white">
              The following fields will be imported:
            </h5>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              @for (field of detectedFields(); track field) {
                <div class="flex items-center gap-2 dark:text-zinc-200">
                  <mat-icon class="text-green-500 dark:text-green-400 text-md"
                    >check_circle</mat-icon
                  >
                  <span>{{ field.csvHeader }}</span>
                  @switch (field.fieldType) {
                    @case (FieldType.TEXT) {
                      <span
                        class="ml-auto text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-900 dark:bg-blue-900 dark:text-blue-100 uppercase border border-blue-300 dark:border-blue-700"
                        >text</span
                      >
                    }
                    @case (FieldType.NUMBER) {
                      <span
                        class="ml-auto text-xs px-2 py-1 rounded-full bg-green-100 text-green-900 dark:bg-green-900 dark:text-green-100 uppercase border border-green-300 dark:border-green-700"
                        >grade</span
                      >
                    }
                    @case (FieldType.EMAIL) {
                      <span
                        class="ml-auto text-xs px-2 py-1 rounded-full bg-orange-100 text-orange-900 dark:bg-orange-900 dark:text-orange-100 uppercase border border-orange-300 dark:border-orange-700"
                        >email</span
                      >
                    }
                    @case (FieldType.DATE) {
                      <span
                        class="ml-auto text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-900 dark:bg-purple-900 dark:text-purple-100 uppercase border border-purple-300 dark:border-purple-700"
                        >date</span
                      >
                    }
                  }
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    }
  </mat-dialog-content>

  <mat-dialog-actions align="end" class="dark:bg-zinc-900">
    <button
      mat-button
      (click)="cancel()"
      [disabled]="isLoading()"
      class="dark:text-zinc-300"
    >
      Cancel
    </button>
    @if (currentStep() > 1) {
      <button
        mat-button
        (click)="prevStep()"
        [disabled]="isLoading()"
        class="dark:text-zinc-300"
      >
        Back
      </button>
    }
    <button
      mat-raised-button
      color="primary"
      (click)="nextStep()"
      [disabled]="!canProceedToNextStep() || isLoading()"
    >
      {{ currentStep() < totalSteps ? 'Next' : 'Import Students' }}
    </button>
  </mat-dialog-actions>
</div>
